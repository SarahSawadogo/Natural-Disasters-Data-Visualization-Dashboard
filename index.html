<html>

<head>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            display: none;
            pointer-events: none;
        }
    </style>

</head>


<body>
    <div id="map"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>

        const width = 960, height = 600;
        const svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoMercator()
            .scale(150)
            .translate([width / 2, height / 1.5]);
        
        const path = d3.geoPath().projection(projection);
        const tooltip = d3.select("#tooltip");

       
        Promise.all([
            d3.csv("1970-2021_DISASTERS.csv"),
            d3.csv("1900_2021_DISASTERS.csv"),
            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
        ]).then(([data1, data2, geoData]) => {
            const combinedData = data1.concat(data2);
            const countryStats = d3.rollups(combinedData, v => {

                const totalDeaths = d3.sum(v, d => +d["Total Deaths"] || 0);
                const totalEconomicLoss = d3.sum(v, d => +d["Total Damages ('000 US$)"] || 0);
                const numberOfDisasters = v.length;
                const commonDisasterSubgroup = d3.mode(v.map(d => d["Disaster Subgroup"]));

                return {
                    averageDeaths: totalDeaths / numberOfDisasters,
                    totalEconomicLoss: totalEconomicLoss,
                    numberOfDisasters: numberOfDisasters,
                    mostCommonDisasterSubgroup: commonDisasterSubgroup
                };

            }, d => d.Country);

            const countryStatsMap = new Map(countryStats);
            svg.append("g")
                .selectAll("path")
                .data(geoData.features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", "#69b3a2")
                .attr("stroke", "#fff")
                .on("mouseover", function(event, d) {

                    const countryName = d.properties.name;
                    const stats = countryStatsMap.get(countryName);
                    if (stats) {
                        tooltip.style("display", "block")
                            .html(`
                                <strong>${countryName}</strong><br>
                                Average Deaths: ${stats.averageDeaths.toFixed(2)}<br>
                                Total Economic Loss: $${stats.totalEconomicLoss.toLocaleString()}<br>
                                Number of Disasters: ${stats.numberOfDisasters}<br>
                                Most Common Disaster Subgroup: ${stats.mostCommonDisasterSubgroup}
                            `);
                    } else {
                        tooltip.style("display", "none");
                    }
                })
                .on("mousemove", function(event) {
                    tooltip.style("top", (event.pageY + 10) + "px")
                           .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                });
        }).catch(error => {
            console.error("Error w csv data pros.", error);
        });
    </script>
</body>
</html>