<html>

<head>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        .tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            display: none;
            pointer-events: none;
        }
        
    </style>

</head>


<body>
    <div id="map"></div>
    <div class="tooltip" id="tooltip"></div>

    <div id="line-chart">
        <svg id="linegraph" height="300" width="400"></svg>
    </div>
    

    <script>

        const width = 960, height = 600;
        const svg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoMercator()
            .scale(150)
            .translate([width / 2, height / 1.5]);
        
        const path = d3.geoPath().projection(projection);
        const tooltip = d3.select("#tooltip");

       
        Promise.all([
            d3.csv("1970-2021_DISASTERS.csv"),
            d3.csv("1900_2021_DISASTERS.csv"),
            d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
        ]).then(([data1, data2, geoData]) => {
            const combinedData = data1.concat(data2);
            const countryStats = d3.rollups(combinedData, v => {

                const totalDeaths = d3.sum(v, d => +d["Total Deaths"] || 0);
                const totalEconomicLoss = d3.sum(v, d => +d["Total Damages ('000 US$)"] || 0);
                const numberOfDisasters = v.length;
                const commonDisasterSubgroup = d3.mode(v.map(d => d["Disaster Subgroup"]));

                return {
                    averageDeaths: totalDeaths / numberOfDisasters,
                    totalEconomicLoss: totalEconomicLoss,
                    numberOfDisasters: numberOfDisasters,
                    mostCommonDisasterSubgroup: commonDisasterSubgroup
                };

            }, d => d.Country);

            const countryStatsMap = new Map(countryStats);
            svg.append("g")
                .selectAll("path")
                .data(geoData.features)
                .enter().append("path")
                .attr("d", path)
                .attr("fill", "#69b3a2")
                .attr("stroke", "#fff")
                .on("mouseover", function(event, d) {

                    const countryName = d.properties.name;
                    const stats = countryStatsMap.get(countryName);

                    // prepare line graph data
                    const countryData = combinedData.filter(d => d.Country === countryName);
                    const disastersOverTime = d3.rollups(
                        countryData,
                        v => v.length,
                        d => +d["Year"]
                    ).sort((a, b) => a[0] - b[0]); // Sort by year

                    if (stats) {
                        tooltip.style("display", "block")
                            .html(`
                                <strong>${countryName}</strong><br>
                                Average Deaths: ${stats.averageDeaths.toFixed(2)}<br>
                                Total Economic Loss: $${stats.totalEconomicLoss.toLocaleString()}<br>
                                Number of Disasters: ${stats.numberOfDisasters}<br>
                                Most Common Disaster Subgroup: ${stats.mostCommonDisasterSubgroup}
                            `);

                        const linegraph = d3.select("svg#linegraph");
                        const margin = { top: 25, right: 30, bottom: 20, left: 30 };
                        const gwidth = +linegraph.attr("width") - margin.left - margin.right;
                        const gheight = +linegraph.attr("height") - margin.top - margin.bottom;

                        const xScale = d3.scaleLinear()
                            .domain([1900, 2020])
                            .range([0, gwidth]);

                        const yScale = d3.scaleLinear()
                            .domain([0, 70])
                            .range([gheight, 0]);
                        
                        linegraph.append("g")
                            .attr("transform", `translate(${margin.left},${margin.top + gheight})`)
                            .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.format("d")));

                        linegraph.append("g")
                            .attr("transform", `translate(${margin.left},${margin.top})`)
                            .call(d3.axisLeft(yScale));

                        const lineGen = d3.line()
                            .x(d => xScale(d[0]))
                            .y(d => yScale(d[1]));
                        
                        linegraph.append("path")
                            .datum(disastersOverTime)
                            .attr("fill", "none")
                            .attr("stroke", "steelblue")
                            .attr("stroke-width", 2)
                            .attr("d", lineGen);

                        linegraph.append("text")
                            .attr("x", margin.left + gwidth / 2)
                            .attr("y", margin.top -10)
                            .attr("text-anchor", "middle")
                            .attr("font-size", "16px")
                            .text(`Annual Disaster Count Over Time: ${countryName}`);

                    } else {
                        tooltip.style("display", "none");
                        d3.select("#linegraph").selectAll("*").remove();
                    }
                    
                })
                .on("mousemove", function(event) {
                    tooltip.style("top", (event.pageY + 10) + "px")
                           .style("left", (event.pageX + 10) + "px");
                })
                .on("mouseout", function() {
                    tooltip.style("display", "none");
                    d3.select("#linegraph").selectAll("*").remove(); // Clear graph on mouseout
                });
        }).catch(error => {
            console.error("Error w csv data pros.", error);
        });
    </script>
</body>
</html>